# Convert CMCC playlist to M3U and commit channels.m3u back to repo using a PAT (Convert_TOKEN)
name: Convert CMCC to M3U

# 给 GITHUB_TOKEN 写权限作为兜底（我们主要用 Convert_TOKEN）
permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      epg_url:
        description: 'EPG XML/URL to include in M3U header'
        required: false
        default: 'https://example.com/epg.xml.gz'
      logo_base_url:
        description: 'Base URL for channel logos (will be prepended if logo path present)'
        required: false
        default: 'https://example.com/logos/'
  push:
    branches:
      - main

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository using Convert_TOKEN
        uses: actions/checkout@v4
        with:
          # 请确认你已在仓库 Secrets 中添加名为 Convert_TOKEN 的 secret（内容为你的 PAT）
          token: ${{ secrets.Convert_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      - name: Debug: show git remote (for debugging permission issues)
        run: |
          git remote -v
          echo "Current user:"
          git config user.name || true
          git rev-parse --abbrev-ref HEAD || true

      - name: Download CMCC playlist
        run: |
          curl -fsSL -o cmcc.raw https://gitee.com/gan2win/IPTV/raw/master/AH_CMCC
          echo "Downloaded cmcc.raw length: $(wc -c < cmcc.raw || echo 0)"

      - name: Convert CMCC to M3U
        env:
          EPG_URL: ${{ github.event.inputs.epg_url || 'https://example.com/epg.xml.gz' }}
          LOGO_BASE_URL: ${{ github.event.inputs.logo_base_url || 'https://example.com/logos/' }}
        run: |
          python3 - <<'PY'
          import re, os, pathlib, html
          src_path = pathlib.Path('cmcc.raw')
          if not src_path.exists():
              print('cmcc.raw not found')
              raise SystemExit(1)
          src = src_path.read_text(encoding='utf-8', errors='ignore')
          lines = [l.strip() for l in src.splitlines() if l.strip()]
          items = []
          for line in lines:
              # skip comments
              if line.startswith('#'):
                  continue
              # common separators: |, tab, comma, space
              parts = re.split(r'[|\t, ]+', line)
              # if line looks like just a URL, skip
              if len(parts) == 1 and re.match(r'^https?://', parts[0]):
                  # could try to fetch title later; skip for now
                  continue
              if len(parts) >= 2:
                  name = parts[0].strip()
                  url = parts[1].strip()
                  logo = parts[2].strip() if len(parts) > 2 else ''
                  # sanitize name for m3u (escape comma)
                  name = name.replace(',', '，')
                  items.append((name, url, logo))
              else:
                  # fallback: try to find url in line
                  m = re.search(r'(https?://\S+)', line)
                  if m:
                      url = m.group(1)
                      name = line.replace(url, '').strip() or url
                      items.append((name, url, ''))
          epg = os.environ.get('EPG_URL', '').strip()
          logo_base = os.environ.get('LOGO_BASE_URL', '').strip()
          header = '#EXTM3U'
          if epg:
              header += f' x-tvg-url="{epg}"'
          if logo_base:
              header += f' tvg-logo="{logo_base}"'
          out = [header]
          for name, url, logo in items:
              attrs = []
              attrs.append(f'tvg-name="{html.escape(name)}"')
              if logo:
                  if re.match(r'^https?://', logo):
                      attrs.append(f'tvg-logo="{logo}"')
                  elif logo_base:
                      attrs.append(f'tvg-logo="{logo_base.rstrip("/")}/{logo.lstrip("/")}"')
              out.append(f'#EXTINF:-1 {" ".join(attrs)},{name}')
              out.append(url)
          out_path = pathlib.Path('channels.m3u')
          out_path.write_text("\n".join(out) + "\n", encoding='utf-8')
          print(f"Wrote {out_path} with {len(items)} items")
          PY

      - name: Commit channels.m3u back to repo (push to main)
        env:
          # 不需要在这里再次传 token，checkout with token + persist-credentials 已设置凭据
        run: |
          git status --porcelain
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add channels.m3u
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "chore: update channels.m3u (converted from CMCC)"
          # 推送到 main；若受分支保护拒绝，会在日志显示 403/remote denied
          echo "Pushing to origin main..."
          git push origin HEAD:main
